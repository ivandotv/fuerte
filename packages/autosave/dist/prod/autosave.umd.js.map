{"version":3,"file":"autosave.umd.js","sources":["../../src/AutosaveCollection.ts","../../src/utils.ts"],"sourcesContent":["import { IReactionDisposer, reaction } from 'mobx'\nimport { FactoryFn, Model } from '@fuerte/core'\nimport { Transport } from '@fuerte/core'\nimport {\n  AutosaveCollectionConfig,\n  RequiredAutosaveCollectionConfig\n} from './types'\nimport { debounceReaction } from './utils'\nimport { Collection } from '@fuerte/core'\n\nexport class AutosaveCollection<\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  TModel extends Model<Collection<any, any, any>>,\n  TFactory extends FactoryFn<TModel>,\n  TTransport extends Transport<TModel>\n> extends Collection<TModel, TFactory, TTransport> {\n  protected identityReactionByCid: Map<string, IReactionDisposer> = new Map()\n\n  protected saveReactionByCid: Map<string, IReactionDisposer> = new Map()\n\n  protected declare config: RequiredAutosaveCollectionConfig\n\n  constructor(\n    factory: TFactory,\n    transport: TTransport,\n    config?: AutosaveCollectionConfig\n  ) {\n    super(factory, transport, config)\n    this.config.autoSave = {\n      enabled: false,\n      debounce: 0,\n      ...(config?.autoSave ? config.autoSave : undefined)\n    }\n  }\n\n  override getConfig(): RequiredAutosaveCollectionConfig {\n    return super.getConfig() as RequiredAutosaveCollectionConfig\n  }\n\n  protected override startTracking(model: TModel): void {\n    super.startTracking(model)\n\n    if (this.config.autoSave.enabled) {\n      this.startAutoSave(model)\n    }\n  }\n\n  protected override stopTracking(model: TModel): void {\n    super.stopTracking(model)\n    const identityR = this.identityReactionByCid.get(model.cid)\n    identityR ? identityR() : null\n\n    this.stopAutoSave(model)\n  }\n\n  protected autoSave(payload: { data: unknown; model: TModel }): void {\n    this.save(payload.model)\n  }\n\n  startAutoSave(): TModel[]\n\n  startAutoSave(model: TModel): TModel | undefined\n\n  startAutoSave(models: TModel[]): TModel[]\n\n  startAutoSave(models?: TModel | TModel[]): TModel | TModel[] | undefined {\n    const modelsArr = models\n      ? Array.isArray(models)\n        ? models\n        : [models]\n      : this._models\n\n    const modelsStarted: TModel[] = []\n    modelsArr.forEach((model) => {\n      const enabled = this.saveReactionByCid.get(model.cid)\n      if (!enabled) {\n        modelsStarted.push(model)\n        const saveReaction = reaction(\n          () => {\n            return {\n              model,\n              data: model.payload\n            }\n          },\n          this.config.autoSave.debounce\n            ? debounceReaction(\n                this.autoSave.bind(this),\n                this.config.autoSave.debounce\n              )\n            : this.autoSave.bind(this),\n          {\n            name: `save-${model.cid}`\n          }\n        )\n\n        this.saveReactionByCid.set(model.cid, saveReaction)\n      }\n    })\n    if (modelsStarted.length) {\n      this.onStartAutoSave(modelsStarted)\n    }\n\n    if (!models || Array.isArray(models)) {\n      return modelsStarted\n    } else {\n      //models is TModel instance\n      return modelsStarted.length ? modelsStarted[0] : undefined\n    }\n  }\n\n  stopAutoSave(): TModel[]\n\n  stopAutoSave(model: TModel): TModel | undefined\n\n  stopAutoSave(models: TModel[]): TModel[]\n\n  stopAutoSave(models?: TModel | TModel[]): TModel | TModel[] | undefined {\n    const modelsArr = models\n      ? Array.isArray(models)\n        ? models\n        : [models]\n      : this._models\n\n    const modelsStopped: TModel[] = []\n    modelsArr.forEach((model) => {\n      const disposer = this.saveReactionByCid.get(model.cid)\n      if (disposer) {\n        disposer()\n        this.saveReactionByCid.delete(model.cid)\n        modelsStopped.push(model)\n      }\n    })\n\n    if (modelsStopped.length) {\n      this.onStopAutoSave(modelsStopped)\n    }\n\n    if (!models || Array.isArray(models)) {\n      return modelsStopped\n    } else {\n      //models is TModel instance\n      return modelsStopped.length ? modelsStopped[0] : undefined\n    }\n  }\n\n  protected onStopAutoSave(models: TModel[]): void {}\n\n  protected onStartAutoSave(models: TModel[]): void {}\n\n  override destroy(): void {\n    super.destroy()\n\n    this.stopAutoSave()\n  }\n\n  autoSaveEnabled(cid: string): boolean {\n    return !!this.saveReactionByCid.get(cid)\n  }\n}\n","/* istanbul ignore file */\nimport type { IReactionPublic } from 'mobx'\n\nexport function debounceReaction<T>(\n  effect: (arg: T, oldArg: T, r: IReactionPublic) => void,\n  debounceMs: number\n): (arg: T, oldArg: T, r: IReactionPublic) => void {\n  let timer: NodeJS.Timeout\n\n  return (arg: T, oldArg: T, r: IReactionPublic) => {\n    clearTimeout(timer)\n    timer = setTimeout(() => effect(arg, oldArg, r), debounceMs)\n  }\n}\n"],"names":["factory","transport","config","_this","identityReactionByCid","Map","saveReactionByCid","autoSave","enabled","debounce","undefined","getConfig","startTracking","model","_Collection","this","startAutoSave","stopTracking","identityR","get","cid","stopAutoSave","payload","save","models","modelsArr","Array","isArray","_models","modelsStarted","forEach","effect","debounceMs","timer","_this2","push","saveReaction","reaction","data","bind","arg","oldArg","r","clearTimeout","setTimeout","name","set","length","onStartAutoSave","modelsStopped","disposer","_this3","onStopAutoSave","destroy","autoSaveEnabled","Collection"],"mappings":"qpBAsBE,WACEA,EACAC,EACAC,gBAEAC,cAAMH,EAASC,EAAWC,UAXlBE,sBAAwD,IAAIC,MAE5DC,kBAAoD,IAAID,IAUhEF,EAAKD,OAAOK,YACVC,SAAS,EACTC,SAAU,SACNP,GAAAA,EAAQK,SAAWL,EAAOK,cAAWG,qFArB/C,2BAyBWC,UAAA,WACP,mBAAaA,wBAGIC,cAAA,SAAcC,GAC/BC,YAAMF,wBAAcC,GAEhBE,KAAKb,OAAOK,SAASC,SACvBO,KAAKC,cAAcH,MAIJI,aAAA,SAAaJ,GAC9BC,YAAMG,uBAAaJ,GACnB,IAAMK,EAAYH,KAAKX,sBAAsBe,IAAIN,EAAMO,KACvDF,GAAYA,IAEZH,KAAKM,aAAaR,MAGVN,SAAA,SAASe,GACjBP,KAAKQ,KAAKD,EAAQT,UASpBG,cAAA,SAAcQ,cACNC,EAAYD,EACdE,MAAMC,QAAQH,GACZA,EACA,CAACA,GACHT,KAAKa,QAEHC,EAA0B,GA8BhC,OA7BAJ,EAAUK,QAAQ,SAACjB,GACjB,ICtEJkB,EACAC,EAEIC,EDoEA,IADgBC,EAAK5B,kBAAkBa,IAAIN,EAAMO,KACnC,CACZS,EAAcM,KAAKtB,GACnB,IAAMuB,EAAeC,WACnB,WACE,MAAO,CACLxB,MAAAA,EACAyB,KAAMzB,EAAMS,UAGhBY,EAAKhC,OAAOK,SAASE,UChF7BsB,EDkFcG,EAAK3B,SAASgC,KAAKL,GCjFjCF,EDkFcE,EAAKhC,OAAOK,SAASE,kBC9E3B+B,EAAQC,EAAWC,GACzBC,aAAaV,GACbA,EAAQW,WAAW,kBAAMb,EAAOS,EAAKC,EAAQC,IAAIV,KD8EvCE,EAAK3B,SAASgC,KAAKL,GACvB,CACEW,aAAchC,EAAMO,MAIxBc,EAAK5B,kBAAkBwC,IAAIjC,EAAMO,IAAKgB,MAGtCP,EAAckB,QAChBhC,KAAKiC,gBAAgBnB,IAGlBL,GAAUE,MAAMC,QAAQH,GACpBK,EAGAA,EAAckB,OAASlB,EAAc,QAAKnB,KAUrDW,aAAA,SAAaG,cACLC,EAAYD,EACdE,MAAMC,QAAQH,GACZA,EACA,CAACA,GACHT,KAAKa,QAEHqB,EAA0B,GAchC,OAbAxB,EAAUK,QAAQ,SAACjB,GACjB,IAAMqC,EAAWC,EAAK7C,kBAAkBa,IAAIN,EAAMO,KAC9C8B,IACFA,IACAC,EAAK7C,yBAAyBO,EAAMO,KACpC6B,EAAcd,KAAKtB,MAInBoC,EAAcF,QAChBhC,KAAKqC,eAAeH,IAGjBzB,GAAUE,MAAMC,QAAQH,GACpByB,EAGAA,EAAcF,OAASE,EAAc,QAAKvC,KAI3C0C,eAAA,SAAe5B,OAEfwB,gBAAA,SAAgBxB,OAEjB6B,QAAA,WACPvC,YAAMuC,mBAENtC,KAAKM,kBAGPiC,gBAAA,SAAgBlC,GACd,QAASL,KAAKT,kBAAkBa,IAAIC,OA7I9BmC"}