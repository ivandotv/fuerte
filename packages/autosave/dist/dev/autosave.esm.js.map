{"version":3,"file":"autosave.esm.js","sources":["../../src/AutosaveCollection.ts","../../src/utils.ts"],"sourcesContent":["import { IReactionDisposer, reaction } from 'mobx'\nimport { FactoryFn, Model } from '@fuerte/core'\nimport { Transport } from '@fuerte/core'\nimport {\n  AutosaveCollectionConfig,\n  RequiredAutosaveCollectionConfig\n} from './types'\nimport { debounceReaction } from './utils'\nimport { Collection } from '@fuerte/core'\n\nexport class AutosaveCollection<\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  TModel extends Model<Collection<any, any, any>>,\n  TFactory extends FactoryFn<TModel>,\n  TTransport extends Transport<TModel>\n> extends Collection<TModel, TFactory, TTransport> {\n  protected identityReactionByCid: Map<string, IReactionDisposer> = new Map()\n\n  protected saveReactionByCid: Map<string, IReactionDisposer> = new Map()\n\n  protected declare config: RequiredAutosaveCollectionConfig\n\n  constructor(\n    factory: TFactory,\n    transport: TTransport,\n    config?: AutosaveCollectionConfig\n  ) {\n    super(factory, transport, config)\n    this.config.autoSave = {\n      enabled: false,\n      debounce: 0,\n      ...(config?.autoSave ? config.autoSave : undefined)\n    }\n  }\n\n  override getConfig(): RequiredAutosaveCollectionConfig {\n    return super.getConfig() as RequiredAutosaveCollectionConfig\n  }\n\n  protected override startTracking(model: TModel): void {\n    super.startTracking(model)\n\n    if (this.config.autoSave.enabled) {\n      this.startAutoSave(model)\n    }\n  }\n\n  protected override stopTracking(model: TModel): void {\n    super.stopTracking(model)\n    const identityR = this.identityReactionByCid.get(model.cid)\n    identityR ? identityR() : null\n\n    this.stopAutoSave(model)\n  }\n\n  protected autoSave(payload: { data: unknown; model: TModel }): void {\n    this.save(payload.model)\n  }\n\n  startAutoSave(): TModel[]\n\n  startAutoSave(model: TModel): TModel | undefined\n\n  startAutoSave(models: TModel[]): TModel[]\n\n  startAutoSave(models?: TModel | TModel[]): TModel | TModel[] | undefined {\n    const modelsArr = models\n      ? Array.isArray(models)\n        ? models\n        : [models]\n      : this._models\n\n    const modelsStarted: TModel[] = []\n    modelsArr.forEach((model) => {\n      const enabled = this.saveReactionByCid.get(model.cid)\n      if (!enabled) {\n        modelsStarted.push(model)\n        const saveReaction = reaction(\n          () => {\n            return {\n              model,\n              data: model.payload\n            }\n          },\n          this.config.autoSave.debounce\n            ? debounceReaction(\n                this.autoSave.bind(this),\n                this.config.autoSave.debounce\n              )\n            : this.autoSave.bind(this),\n          {\n            name: `save-${model.cid}`\n          }\n        )\n\n        this.saveReactionByCid.set(model.cid, saveReaction)\n      }\n    })\n    if (modelsStarted.length) {\n      this.onStartAutoSave(modelsStarted)\n    }\n\n    if (!models || Array.isArray(models)) {\n      return modelsStarted\n    } else {\n      //models is TModel instance\n      return modelsStarted.length ? modelsStarted[0] : undefined\n    }\n  }\n\n  stopAutoSave(): TModel[]\n\n  stopAutoSave(model: TModel): TModel | undefined\n\n  stopAutoSave(models: TModel[]): TModel[]\n\n  stopAutoSave(models?: TModel | TModel[]): TModel | TModel[] | undefined {\n    const modelsArr = models\n      ? Array.isArray(models)\n        ? models\n        : [models]\n      : this._models\n\n    const modelsStopped: TModel[] = []\n    modelsArr.forEach((model) => {\n      const disposer = this.saveReactionByCid.get(model.cid)\n      if (disposer) {\n        disposer()\n        this.saveReactionByCid.delete(model.cid)\n        modelsStopped.push(model)\n      }\n    })\n\n    if (modelsStopped.length) {\n      this.onStopAutoSave(modelsStopped)\n    }\n\n    if (!models || Array.isArray(models)) {\n      return modelsStopped\n    } else {\n      //models is TModel instance\n      return modelsStopped.length ? modelsStopped[0] : undefined\n    }\n  }\n\n  protected onStopAutoSave(models: TModel[]): void {}\n\n  protected onStartAutoSave(models: TModel[]): void {}\n\n  override destroy(): void {\n    super.destroy()\n\n    this.stopAutoSave()\n  }\n\n  autoSaveEnabled(cid: string): boolean {\n    return !!this.saveReactionByCid.get(cid)\n  }\n}\n","/* istanbul ignore file */\nimport type { IReactionPublic } from 'mobx'\n\nexport function debounceReaction<T>(\n  effect: (arg: T, oldArg: T, r: IReactionPublic) => void,\n  debounceMs: number\n): (arg: T, oldArg: T, r: IReactionPublic) => void {\n  let timer: NodeJS.Timeout\n\n  return (arg: T, oldArg: T, r: IReactionPublic) => {\n    clearTimeout(timer)\n    timer = setTimeout(() => effect(arg, oldArg, r), debounceMs)\n  }\n}\n"],"names":["AutosaveCollection","Collection","constructor","factory","transport","config","super","identityReactionByCid","Map","saveReactionByCid","this","autoSave","enabled","debounce","undefined","getConfig","startTracking","model","startAutoSave","stopTracking","identityR","get","cid","stopAutoSave","payload","save","models","modelsArr","Array","isArray","_models","modelsStarted","forEach","push","saveReaction","reaction","data","effect","debounceMs","timer","arg","oldArg","r","clearTimeout","setTimeout","debounceReaction","bind","name","set","length","onStartAutoSave","modelsStopped","disposer","delete","onStopAutoSave","destroy","autoSaveEnabled"],"mappings":"gSAUaA,UAKHC,EAORC,YACEC,EACAC,EACAC,GAEAC,MAAMH,EAASC,EAAWC,QAXlBE,sBAAwD,IAAIC,SAE5DC,kBAAoD,IAAID,IAUhEE,KAAKL,OAAOM,YACVC,SAAS,EACTC,SAAU,SACNR,GAAAA,EAAQM,SAAWN,EAAOM,cAAWG,GAIpCC,YACP,aAAaA,YAGIC,cAAcC,GAC/BX,MAAMU,cAAcC,GAEhBP,KAAKL,OAAOM,SAASC,SACvBF,KAAKQ,cAAcD,GAIJE,aAAaF,GAC9BX,MAAMa,aAAaF,GACnB,MAAMG,EAAYV,KAAKH,sBAAsBc,IAAIJ,EAAMK,KACvDF,GAAYA,IAEZV,KAAKa,aAAaN,GAGVN,SAASa,GACjBd,KAAKe,KAAKD,EAAQP,OASpBC,cAAcQ,GACZ,MAAMC,EAAYD,EACdE,MAAMC,QAAQH,GACZA,EACA,CAACA,GACHhB,KAAKoB,QAEHC,EAA0B,GA8BhC,OA7BAJ,EAAUK,QAASf,IAEjB,IADgBP,KAAKD,kBAAkBY,IAAIJ,EAAMK,KACnC,CACZS,EAAcE,KAAKhB,GACnB,MAAMiB,EAAeC,EACnB,KACS,CACLlB,MAAAA,EACAmB,KAAMnB,EAAMO,UAGhBd,KAAKL,OAAOM,SAASE,kBChF7BwB,EACAC,GAEA,IAAIC,EAEJ,MAAO,CAACC,EAAQC,EAAWC,KACzBC,aAAaJ,GACbA,EAAQK,WAAW,IAAMP,EAAOG,EAAKC,EAAQC,GAAIJ,ID0EvCO,CACEnC,KAAKC,SAASmC,KAAKpC,MACnBA,KAAKL,OAAOM,SAASE,UAEvBH,KAAKC,SAASmC,KAAKpC,MACvB,CACEqC,aAAc9B,EAAMK,QAIxBZ,KAAKD,kBAAkBuC,IAAI/B,EAAMK,IAAKY,MAGtCH,EAAckB,QAChBvC,KAAKwC,gBAAgBnB,IAGlBL,GAAUE,MAAMC,QAAQH,GACpBK,EAGAA,EAAckB,OAASlB,EAAc,QAAKjB,EAUrDS,aAAaG,GACX,MAAMC,EAAYD,EACdE,MAAMC,QAAQH,GACZA,EACA,CAACA,GACHhB,KAAKoB,QAEHqB,EAA0B,GAchC,OAbAxB,EAAUK,QAASf,IACjB,MAAMmC,EAAW1C,KAAKD,kBAAkBY,IAAIJ,EAAMK,KAC9C8B,IACFA,IACA1C,KAAKD,kBAAkB4C,OAAOpC,EAAMK,KACpC6B,EAAclB,KAAKhB,MAInBkC,EAAcF,QAChBvC,KAAK4C,eAAeH,IAGjBzB,GAAUE,MAAMC,QAAQH,GACpByB,EAGAA,EAAcF,OAASE,EAAc,QAAKrC,EAI3CwC,eAAe5B,IAEfwB,gBAAgBxB,IAEjB6B,UACPjD,MAAMiD,UAEN7C,KAAKa,eAGPiC,gBAAgBlC,GACd,QAASZ,KAAKD,kBAAkBY,IAAIC"}